#!/usr/bin/env bash
set -euo pipefail

SPIKE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)/spikes"
CONFIG_FILE="$HOME/.spike-lab"
JULES_API="https://jules.googleapis.com/v1alpha"

# Load config if exists
if [[ -f "$CONFIG_FILE" ]]; then
    source "$CONFIG_FILE"
fi

usage() {
    cat <<EOF
spike - Manage research spikes with Jules integration

USAGE:
    spike new <name> [description]   Create a new spike directory
    spike jules <name> <task>        Send spike task to Jules
    spike list                       List all spikes
    spike status <name>              Show spike status

    JULES CLI:
    spike check                      Check session status (stuck/working/done)
    spike watch                      Launch Jules TUI (monitor/assist sessions)
    spike sessions                   List all Jules sessions
    spike pull <session-id>          Pull session results
    spike teleport <session-id>      Checkout branch with Jules' changes

    JULES API (programmatic):
    spike api-setup                  Configure API key
    spike api-sessions               List sessions via API
    spike api-status <session-id>    Get detailed session status
    spike api-message <id> <msg>     Send message to help stuck agent
    spike api-approve <session-id>   Approve a session's plan

    spike help                       Show this help

EXAMPLES:
    spike new graphql-perf "Investigate GraphQL query performance"
    spike jules graphql-perf "Profile and optimize N+1 queries"
    spike sessions                   # find session ID
    spike watch                      # interact with stuck session
    spike api-message 123 "try using the v2 API instead"  # help stuck agent
    spike pull 123456                # grab results
EOF
}

cmd_new() {
    local name="${1:-}"
    local desc="${2:-}"

    if [[ -z "$name" ]]; then
        echo "Error: spike name required" >&2
        echo "Usage: spike new <name> [description]" >&2
        exit 1
    fi

    local spike_path="$SPIKE_DIR/$name"

    if [[ -d "$spike_path" ]]; then
        echo "Error: spike '$name' already exists" >&2
        exit 1
    fi

    mkdir -p "$spike_path"/{notes,artifacts}

    cat > "$spike_path/README.md" <<SPIKE_README
# Spike: $name

${desc:-_No description provided_}

## Status
- [ ] In Progress
- [ ] Complete

## Goal
_Define the research goal here_

## Tasks
- [ ] Initial research
- [ ] Prototype
- [ ] Document findings

## Findings
_Record findings here_

## Jules Sessions
_Track Jules session IDs here_

## Artifacts
See \`./artifacts/\` for any code, diagrams, or outputs.

## Notes
See \`./notes/\` for detailed notes.
SPIKE_README

    echo "Created spike: $spike_path"
    echo "  - README.md"
    echo "  - notes/"
    echo "  - artifacts/"
}

cmd_jules() {
    local name="${1:-}"
    local task="${2:-}"

    if [[ -z "$name" ]] || [[ -z "$task" ]]; then
        echo "Error: spike name and task required" >&2
        echo "Usage: spike jules <name> <task>" >&2
        exit 1
    fi

    local spike_path="$SPIKE_DIR/$name"

    if [[ ! -d "$spike_path" ]]; then
        echo "Error: spike '$name' does not exist" >&2
        echo "Create it first: spike new $name" >&2
        exit 1
    fi

    echo "Sending to Jules: $task"
    jules new "$task"

    # Log the task
    echo "$(date -Iseconds) | $task" >> "$spike_path/jules-tasks.log"
}

cmd_list() {
    if [[ ! -d "$SPIKE_DIR" ]] || [[ -z "$(ls -A "$SPIKE_DIR" 2>/dev/null)" ]]; then
        echo "No spikes found. Create one with: spike new <name>"
        exit 0
    fi

    echo "Spikes:"
    for spike in "$SPIKE_DIR"/*/; do
        if [[ -d "$spike" ]]; then
            local name=$(basename "$spike")
            local status="active"
            if grep -q "\[x\] Complete" "$spike/README.md" 2>/dev/null; then
                status="complete"
            fi
            printf "  %-30s [%s]\n" "$name" "$status"
        fi
    done
}

cmd_status() {
    local name="${1:-}"

    if [[ -z "$name" ]]; then
        echo "Error: spike name required" >&2
        exit 1
    fi

    local spike_path="$SPIKE_DIR/$name"

    if [[ ! -d "$spike_path" ]]; then
        echo "Error: spike '$name' does not exist" >&2
        exit 1
    fi

    echo "=== Spike: $name ==="
    echo ""

    if [[ -f "$spike_path/README.md" ]]; then
        head -30 "$spike_path/README.md"
    fi

    if [[ -f "$spike_path/jules-tasks.log" ]]; then
        echo ""
        echo "=== Jules Tasks ==="
        cat "$spike_path/jules-tasks.log"
    fi
}

cmd_watch() {
    echo "Launching Jules TUI..."
    echo "Tip: Use this to monitor sessions, provide guidance, or unstick agents"
    jules
}

cmd_sessions() {
    echo "=== Jules Sessions ==="
    jules remote list --session
}

cmd_check() {
    local output
    output=$(jules remote list --session 2>&1)

    echo "=== Session Status ==="
    echo "$output"
    echo ""

    # Parse and summarize
    local total=0
    local working=0
    local stuck=0
    local done=0
    local needs_input=0

    while IFS= read -r line; do
        # Skip header and empty/whitespace-only lines
        [[ "$line" =~ ^[[:space:]]*ID ]] && continue
        [[ -z "${line// }" ]] && continue
        [[ ! "$line" =~ [0-9] ]] && continue  # Must have session ID (number)

        ((total++)) || true

        if [[ "$line" =~ "working" ]] || [[ "$line" =~ "running" ]] || [[ "$line" =~ "in progress" ]]; then
            ((working++)) || true
        elif [[ "$line" =~ "stuck" ]] || [[ "$line" =~ "blocked" ]] || [[ "$line" =~ "error" ]]; then
            ((stuck++)) || true
            echo "‚ö†Ô∏è  STUCK: $line"
        elif [[ "$line" =~ "waiting" ]] || [[ "$line" =~ "input" ]] || [[ "$line" =~ "review" ]]; then
            ((needs_input++)) || true
            echo "üëÄ NEEDS INPUT: $line"
        elif [[ "$line" =~ "done" ]] || [[ "$line" =~ "complete" ]] || [[ "$line" =~ "finished" ]]; then
            ((done++)) || true
        fi
    done <<< "$output"

    if [[ $total -eq 0 ]]; then
        echo "No active sessions"
    else
        echo ""
        echo "Summary: $total sessions | $working working | $needs_input need input | $stuck stuck | $done done"

        if [[ $stuck -gt 0 ]] || [[ $needs_input -gt 0 ]]; then
            echo ""
            echo "Run 'spike watch' to assist sessions that need attention"
        fi
    fi
}

cmd_pull() {
    local session_id="${1:-}"

    if [[ -z "$session_id" ]]; then
        echo "Error: session ID required" >&2
        echo "Usage: spike pull <session-id>" >&2
        echo "Run 'spike sessions' to list available sessions" >&2
        exit 1
    fi

    echo "Pulling session $session_id..."
    jules remote pull --session "$session_id"
}

cmd_teleport() {
    local session_id="${1:-}"

    if [[ -z "$session_id" ]]; then
        echo "Error: session ID required" >&2
        echo "Usage: spike teleport <session-id>" >&2
        echo "Run 'spike sessions' to list available sessions" >&2
        exit 1
    fi

    echo "Teleporting to session $session_id..."
    echo "This will checkout the branch with Jules' changes"
    jules teleport "$session_id"
}

# ============ API Commands ============

require_api_key() {
    if [[ -z "${JULES_API_KEY:-}" ]]; then
        echo "Error: JULES_API_KEY not set" >&2
        echo "Run 'spike api-setup' to configure" >&2
        exit 1
    fi
}

api_call() {
    local method="$1"
    local endpoint="$2"
    local data="${3:-}"

    local args=(-s -X "$method" -H "x-goog-api-key: $JULES_API_KEY" -H "Content-Type: application/json")

    if [[ -n "$data" ]]; then
        args+=(-d "$data")
    fi

    curl "${args[@]}" "${JULES_API}${endpoint}"
}

cmd_api_setup() {
    echo "Jules API Setup"
    echo "==============="
    echo ""
    echo "1. Open: https://jules.google.com/settings#api"
    echo "2. Generate or copy your API key"
    echo ""
    read -rp "Paste your API key: " api_key

    if [[ -z "$api_key" ]]; then
        echo "Error: No API key provided" >&2
        exit 1
    fi

    # Test the key
    echo "Testing API key..."
    local response
    response=$(curl -s -w "\n%{http_code}" -H "x-goog-api-key: $api_key" "${JULES_API}/sessions?pageSize=1")
    local http_code
    http_code=$(echo "$response" | tail -1)

    if [[ "$http_code" != "200" ]]; then
        echo "Error: API key validation failed (HTTP $http_code)" >&2
        echo "$response" | head -5 >&2
        exit 1
    fi

    # Save to config
    echo "JULES_API_KEY=\"$api_key\"" > "$CONFIG_FILE"
    chmod 600 "$CONFIG_FILE"

    echo "API key saved to $CONFIG_FILE"
    echo "You can now use spike api-* commands"
}

cmd_api_sessions() {
    require_api_key

    echo "=== Jules Sessions (API) ==="
    local response
    response=$(api_call GET "/sessions?pageSize=20")

    # Pretty print with jq if available, otherwise raw
    if command -v jq &>/dev/null; then
        echo "$response" | jq -r '
            .sessions[]? |
            "\(.name | split("/") | last)\t\(.state // "unknown")\t\(.title // .prompt[:50])"
        ' 2>/dev/null | column -t -s $'\t' || echo "$response"
    else
        echo "$response"
    fi
}

cmd_api_status() {
    require_api_key
    local session_id="${1:-}"

    if [[ -z "$session_id" ]]; then
        echo "Error: session ID required" >&2
        echo "Usage: spike api-status <session-id>" >&2
        exit 1
    fi

    echo "=== Session $session_id ==="
    local response
    response=$(api_call GET "/sessions/$session_id")

    if command -v jq &>/dev/null; then
        echo "$response" | jq '.'
    else
        echo "$response"
    fi

    echo ""
    echo "=== Activities ==="
    local activities
    activities=$(api_call GET "/sessions/$session_id/activities?pageSize=10")

    if command -v jq &>/dev/null; then
        echo "$activities" | jq -r '
            .activities[]? |
            "[\(.activityType // "unknown")] \(.content[:100] // .summary[:100] // "no content")"
        ' 2>/dev/null || echo "$activities"
    else
        echo "$activities"
    fi
}

cmd_api_message() {
    require_api_key
    local session_id="${1:-}"
    local message="${2:-}"

    if [[ -z "$session_id" ]] || [[ -z "$message" ]]; then
        echo "Error: session ID and message required" >&2
        echo "Usage: spike api-message <session-id> <message>" >&2
        exit 1
    fi

    echo "Sending message to session $session_id..."
    local response
    response=$(api_call POST "/sessions/$session_id:sendMessage" "{\"prompt\": \"$message\"}")

    if command -v jq &>/dev/null; then
        echo "$response" | jq '.'
    else
        echo "$response"
    fi

    echo ""
    echo "Message sent. Jules will process and respond."
}

cmd_api_approve() {
    require_api_key
    local session_id="${1:-}"

    if [[ -z "$session_id" ]]; then
        echo "Error: session ID required" >&2
        echo "Usage: spike api-approve <session-id>" >&2
        exit 1
    fi

    echo "Approving plan for session $session_id..."
    local response
    response=$(api_call POST "/sessions/$session_id:approvePlan" "{}")

    if command -v jq &>/dev/null; then
        echo "$response" | jq '.'
    else
        echo "$response"
    fi

    echo ""
    echo "Plan approved. Jules will proceed with implementation."
}

# Main dispatch
case "${1:-help}" in
    new)      shift; cmd_new "$@" ;;
    jules)    shift; cmd_jules "$@" ;;
    list)     cmd_list ;;
    status)   shift; cmd_status "$@" ;;
    check)    cmd_check ;;
    watch)    cmd_watch ;;
    sessions) cmd_sessions ;;
    pull)     shift; cmd_pull "$@" ;;
    teleport) shift; cmd_teleport "$@" ;;
    api-setup)   cmd_api_setup ;;
    api-sessions) cmd_api_sessions ;;
    api-status)  shift; cmd_api_status "$@" ;;
    api-message) shift; cmd_api_message "$@" ;;
    api-approve) shift; cmd_api_approve "$@" ;;
    help|--help|-h) usage ;;
    *)
        echo "Unknown command: $1" >&2
        usage >&2
        exit 1
        ;;
esac
